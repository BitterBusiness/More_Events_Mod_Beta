####################################
#
# Antaran Menace - Midgame Crisis
#
# Coding by Malthus
#
####################################

namespace = mem_antarans

#Fleet spawning events start at 100

#Setup Event at Game Start for randomly disabling the Crisis
event = {
	id = mem_antarans.1
	hide_window = yes
	
	immediate = {
		random_list = {
#			3 = {
#				set_global_flag = mem_antarans_disabled
#			}
			1 = {
				set_timed_global_flag = {
					flag = mem_antarans_recent_attack
					days = 9000 # 25 years
				}
				create_country = {
					name = "The Dark Ones"
					type = mem_antarans
					flag = {
						icon = {
							category = "domination"
							file = "domination_21.dds"
						}
						background= {
							category = "backgrounds"
							file = "00_solid.dds"
						}
						colors={
							"black"
							"dark_purple"
							"null"
							"null"
						}
					}
				}
				last_created_country = {
					set_country_flag = mem_antarans_country
				}
			}
		}
	}
}

#Empire Targeting for Raids
planet_event = {
	id = mem_antarans.2
	hide_window = yes
	
	trigger = {
		is_colony = yes
		is_capital = no
		NOR = {
			has_planet_flag = mem_antarans_raided_planet #this is a timed flag set when the planet is raided 
			has_global_flag = mem_antarans_recent_attack #this is a timed flag set at the start of a raid
			has_global_flag = mem_antarans_disabled
		}
		owner = {
			is_country_type = default
			NOR = {
				has_country_flag = mem_antarans_raided_empire #this is a timed flag set when an empire gets attacked
				has_country_flag = mem_antarans_target_1
				has_country_flag = mem_antarans_target_2
				has_country_flag = mem_antarans_target_3
				has_country_flag = mem_antarans_target_4
				has_country_flag = mem_antarans_target_5
			}
		}
	}
	
	mean_time_to_happen = {
		months = 32
	}
	
	immediate = {
		IF = {
			limit = {
				NOT = {
					any_country = {
						has_country_flag = mem_antarans_target_1
					}
				}
			}
			owner = {
				set_country_flag = mem_antarans_target_1
			}
			ELSE = {
				IF = {
					limit = {
						NOT = {
							any_country = {
								has_country_flag = mem_antarans_target_2
							}
						}
					}
					owner = {
						set_country_flag = mem_antarans_target_2
					}
					ELSE = {
						IF = {
							limit = {
								NOT = {
									any_country = {
										has_country_flag = mem_antarans_target_3
									}
								}
							}
							owner = {
								set_country_flag = mem_antarans_target_3
							}
							ELSE = {
								IF = {
									limit = {
										NOT = {
											any_country = {
												has_country_flag = mem_antarans_target_4
											}
										}
									}
									owner = {
										set_country_flag = mem_antarans_target_4
									}
									ELSE = {
										IF = {
											limit = {
												NOT = {
													any_country = {
														has_country_flag = mem_antarans_target_5
													}
												}
											}
											owner = {
												set_country_flag = mem_antarans_target_5
											}
											#set a break between attack rounds
											set_timed_global_flag = {
												flag = mem_antarans_recent_attack
												days = 3600 # 10 years
											}
											# TODO this is for testing purpose, take out later
											random_country = {
												limit = {
													is_ai = no
												}
												country_event = { id = mem_antarans.99 days = 5 }
											}
											#Following events set the Antaran Raids in motion
											random_country = {
												limit = {
													has_country_flag = mem_antarans_target_1
												}
												country_event = { id = mem_antarans.3 days = 30 random = 10 }
											}
											random_country = {
												limit = {
													has_country_flag = mem_antarans_target_2
												}
												country_event = { id = mem_antarans.3 days = 30 random = 10 }
											}
											random_country = {
												limit = {
													has_country_flag = mem_antarans_target_3
												}
												country_event = { id = mem_antarans.3 days = 30 random = 10 }
											}
											random_country = {
												limit = {
													has_country_flag = mem_antarans_target_4
												}
												country_event = { id = mem_antarans.3 days = 30 random = 10 }
											}
											random_country = {
												limit = {
													has_country_flag = mem_antarans_target_5
												}
												country_event = { id = mem_antarans.3 days = 30 random = 10 }
											}
											# TODO Also start a notification message for all not attacked human players from here later
											every_country = {
												limit = {
													NOR = {
														has_country_flag = mem_antarans_target_1
														has_country_flag = mem_antarans_target_2
														has_country_flag = mem_antarans_target_3
														has_country_flag = mem_antarans_target_4
														has_country_flag = mem_antarans_target_5
													}
													is_ai = no
												}
												# TODO start notification event a month later than the other events
											}
										}
									}
								}
							}
						}
					}
				}
			}
		}
	}
}

#Hidden Event to place the Ambient Object ( Dimensional Rift opening ) at the rim of a target system
country_event = {
	id = mem_antarans.3
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		IF = { # check if the empire is target of a retaliation
			limit = {
				has_country_flag = mem_antarans_retaliation
			}
			remove_country_flag = mem_antarans_retaliation
			random_owned_planet = {
				limit = {
					is_capital = yes
				}
				solar_system = {
					random_system_planet = {
						limit = {
							is_star = yes
						}
						THIS = {
							save_event_target_as = mem_antarans_target_sun
						}
					}
					create_ambient_object = { # TODO exchange that later with a custom made one from frog
						type = "abandoned_ship_object"
					}
					random_system_ambient_object = {
						limit = { is_same_value = last_created_ambient_object }
						set_location = {
							target = event_target:mem_antarans_target_sun
							distance = 150
							angle = random
						}
						set_ambient_object_flag = mem_antarans_rift
						save_event_target_as = mem_antarans_rift
					}
				}
			}
			# start next event to notify the player
			country_event = { id = mem_antarans.4 days = 5 }
			# start overnext event to open the rift and spawn enemy fleet
			country_event = { id = mem_antarans.5 days = 30 }
			ELSE = {
				IF = { # failsafe check if valid raiding target has been lost in the meantime because of a war or something else - check here and use normal raiding target
					limit = {
						any_owned_planet = {
							is_colony = yes
							is_capital = no
							NOT = {
								has_planet_flag = mem_antarans_raided_planet
							}
						}
					}
					random_owned_planet = {
						limit = {
							is_colony = yes
							is_capital = no
							NOT = {
								has_planet_flag = mem_antarans_raided_planet
							}
						}
						solar_system = {
							random_system_planet = {
								limit = {
									is_star = yes
								}
								THIS = {
									save_event_target_as = mem_antarans_target_sun
								}
							}
							create_ambient_object = { # TODO exchange that later with a custom made one by frog
								type = "abandoned_ship_object"
							}
							random_system_ambient_object = {
								limit = { is_same_value = last_created_ambient_object }
								set_location = {
									target = event_target:mem_antarans_target_sun
									distance = 150
									angle = random
								}
								set_ambient_object_flag = mem_antarans_rift
								save_event_target_as = mem_antarans_rift
							}
						}
					}
					# start next event to notify the player
					country_event = { id = mem_antarans.4 days = 5 }
					# start overnext event to open the rift and spawn enemy fleet
					country_event = { id = mem_antarans.5 days = 30 }
					ELSE = { # failsafe target - if not even the capital is left there is nothing happening anyway
						random_owned_planet = {
							limit = {
								is_colony = yes
							}
							solar_system = {
								random_system_planet = {
									limit = {
										is_star = yes
									}
									THIS = {
										save_event_target_as = mem_antarans_target_sun
									}
								}
								create_ambient_object = { # TODO exchange that later with a custom made one by frog
									type = "abandoned_ship_object"
								}
								random_system_ambient_object = {
									limit = { is_same_value = last_created_ambient_object }
									set_location = {
										target = event_target:mem_antarans_target_sun
										distance = 150
										angle = random
									}
									set_ambient_object_flag = mem_antarans_rift
									save_event_target_as = mem_antarans_rift
								}
							}
						}
						# start next event to notify the player
						country_event = { id = mem_antarans.4 days = 5 }
						# start overnext event to open the rift and spawn enemy fleet
						country_event = { id = mem_antarans.5 days = 30 }
					}
				}
			}
		}
	}
}

#Notification Event that a Rift is forming
country_event = {
	id = mem_antarans.4
	title = mem_antarans.4.name
	desc = { # for first encounter
		text = mem_antarans.4a.desc
		trigger = {
			NOT = { 
				has_country_flag = mem_antarans_retaliation 
				has_country_flag = mem_antarans_met
			}
		}
	}
	desc = { # after first encounter has happened before
		text = mem_antarans.4b.desc
		trigger = {
			NOT = { 
				has_country_flag = mem_antarans_retaliation 
			}
			has_country_flag = mem_antarans_met
		}
	}
	desc = { # for retaliation encounter
		text = mem_antarans.4c.desc
		trigger = { has_country_flag = mem_antarans_retaliation }
	}
	picture = GFX_evt_mem_space_battle # TODO we will need custom art for a picture of one of those rifts opening
	location = event_target:mem_antarans_target_sun
	
	is_triggered_only = yes
	
	option = {
		name = "YEAHHHHHH!" # replace later
	}
}

#Rift opens and fleet spawn events get linked
country_event = {
	id = mem_antarans.5
	title = mem_antarans.5.name
	desc = { # for first encounter
		text = mem_antarans.5a.desc
		trigger = {
			NOT = { 
				has_country_flag = mem_antarans_retaliation
				has_country_flag = mem_antarans_met
			}
		}
	}
	desc = { # after first encounter has happened before
		text = mem_antarans.5b.desc
		trigger = {
			NOT = { 
				has_country_flag = mem_antarans_retaliation 
			}
			has_country_flag = mem_antarans_met
		}
	}
	desc = { # for retaliation encounter
		text = mem_antarans.5c.desc
		trigger = { has_country_flag = mem_antarans_retaliation }
	}
	picture = GFX_evt_mem_space_battle # TODO we will need custom art for a picture of an opened rifts with ships coming through
	location = event_target:mem_antarans_rift
	
	is_triggered_only = yes
	
	immediate = {
		IF = { #in case of retaliation strike
			limit = {
				has_country_flag = mem_antarans_retaliation
			}
			# TODO Spawn event with diplo screen telling the player to face their wrath
			# Start spawning Retaliation fleet
			country_event = { id = mem_antarans.100 days = 2 }
		}
		IF = { #in case of first raiding encounter
			limit = {
				NOT = {
					has_country_flag = mem_antarans_retaliation
					has_country_flag = mem_antarans_met
				}
			}
			# TODO Spawn event with diplo screen telling the player to back off or face doom
			# Start spawning Raiding fleet
			country_event = { id = mem_antarans.101 days = 2 }
		}
		IF = { #in case of later raiding encounter
			limit = {
				NOT = {
					has_country_flag = mem_antarans_retaliation
				}
				has_country_flag = mem_antarans_met
			}
			# TODO Spawn event with diplo screen telling the player they are back to take more
			# Start spawning Raiding fleet
			country_event = { id = mem_antarans.101 days = 2 }
		}
	}
	# TODO make unseful options as reply based on ethics
}

#Retaliation Fleet spawn
country_event = {
	id = mem_antarans.100
    hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		random_country = {
			limit = {
				has_country_flag = mem_antarans_country
			}
			THIS = {
				save_event_target_as = mem_antarans_country
			}
		}
		random_system = {
			limit = {
				any_planet = {
					is_owned_by = root
				}
				any_ambient_object = {
					has_ambient_object_flag = mem_antarans_rift
				}
			}
			random_system_ambient_object = {
				limit = {
					has_ambient_object_flag = mem_antarans_rift
				}
				create_fleet = {
					name = "Raiders"
					settings = {
						spawn_debris = no 
						is_boss = no
					}
					effect = {
						set_owner = event_target:mem_antarans_country
						create_ship = {
							design = "Spearhead"
						}
						set_location = {
							target = PREV
							distance = 0
							angle = random 
						}
					}
				}
				last_created_fleet = { # fleet flag for bombarding event
					set_fleet_flag = mem_antarans_fleet
				}
				IF = { # check which attack number the empire has (1 to 5) for destruction check to know which empire will be the target of a retaliation strike
					limit = {
						ROOT = {
							has_country_flag = mem_antarans_target_1
						}
					}
					last_created_fleet = {
						set_fleet_flag = mem_antarans_fleet_1
					}
				}
				IF = { # check which attack number the empire has (1 to 5) for destruction check to know which empire will be the target of a retaliation strike
					limit = {
						ROOT = {
							has_country_flag = mem_antarans_target_2
						}
					}
					last_created_fleet = {
						set_fleet_flag = mem_antarans_fleet_2
					}
				}
				IF = { # check which attack number the empire has (1 to 5) for destruction check to know which empire will be the target of a retaliation strike
					limit = {
						ROOT = {
							has_country_flag = mem_antarans_target_3
						}
					}
					last_created_fleet = {
						set_fleet_flag = mem_antarans_fleet_3
					}
				}
				IF = { # check which attack number the empire has (1 to 5) for destruction check to know which empire will be the target of a retaliation strike
					limit = {
						ROOT = {
							has_country_flag = mem_antarans_target_4
						}
					}
					last_created_fleet = {
						set_fleet_flag = mem_antarans_fleet_4
					}
				}
				IF = { # check which attack number the empire has (1 to 5) for destruction check to know which empire will be the target of a retaliation strike
					limit = {
						ROOT = {
							has_country_flag = mem_antarans_target_5
						}
					}
					last_created_fleet = {
						set_fleet_flag = mem_antarans_fleet_5
					}
				}
			}
		}
	}
}

#Raiding Fleet spawn
country_event = {
	id = mem_antarans.101
    hide_window = yes
	
	is_triggered_only = yes

	immediate = {
		random_country = {
			limit = {
				has_country_flag = mem_antarans_country
			}
			THIS = {
				save_event_target_as = mem_antarans_country
			}
		}
		random_system = {
			limit = {
				any_planet = {
					is_owned_by = root
				}
				any_ambient_object = {
					has_ambient_object_flag = mem_antarans_rift
				}
			}
			random_system_ambient_object = {
				limit = {
					has_ambient_object_flag = mem_antarans_rift
				}
				IF = { # weakest raiding fleet if not having researched destroyers yet
					limit = {
						ROOT = {
							NOT = {
								has_technology = tech_spaceport_3
							}
						}
					}
					create_fleet = {
						name = "Raiders"
						settings = {
							spawn_debris = no 
							is_boss = no
						}
						effect = {
							set_owner = event_target:mem_antarans_country
							create_ship = {
								design = "Spearhead"
							}
							set_location = {
								target = PREV
								distance = 0
								angle = random 
							}
						}
					}
				}
				IF = { # raiding fleet if not having researched cruisers yet
					limit = {
						ROOT = {
							has_technology = tech_spaceport_3
							NOT = {
								has_technology = tech_spaceport_5
							}
						}
					}
					create_fleet = {
						name = "Raiders"
						settings = {
							spawn_debris = no 
							is_boss = no
						}
						effect = {
							set_owner = event_target:mem_antarans_country
							create_ship = {
								design = "Spearhead"
							}
							set_location = {
								target = PREV
								distance = 0
								angle = random 
							}
						}
					}
				}
				IF = { # raiding fleet if not having researched battleships yet
					limit = {
						ROOT = {
							has_technology = tech_spaceport_5
							NOT = {
								has_technology = tech_spaceport_6
							}
						}
					}
					create_fleet = {
						name = "Raiders"
						settings = {
							spawn_debris = no 
							is_boss = no
						}
						effect = {
							set_owner = event_target:mem_antarans_country
							create_ship = {
								design = "Spearhead"
							}
							set_location = {
								target = PREV
								distance = 0
								angle = random 
							}
						}
					}
				}
				IF = { # raiding fleet if not having researched any xl t1 weapon yet
					limit = {
						ROOT = {
							has_technology = tech_spaceport_6
							NOR = {
								has_technology = tech_energy_lance_1
								has_technology = tech_mass_accelerator_1
								has_technology = tech_arc_emitter_1
							}
						}
					}
					create_fleet = {
						name = "Raiders"
						settings = {
							spawn_debris = no 
							is_boss = no
						}
						effect = {
							set_owner = event_target:mem_antarans_country
							create_ship = {
								design = "Spearhead"
							}
							set_location = {
								target = PREV
								distance = 0
								angle = random 
							}
						}
					}
				}
				IF = { # raiding fleet if not having researched any xl t2 weapon yet
					limit = {
						ROOT = {
							OR = {
								has_technology = tech_energy_lance_1
								has_technology = tech_mass_accelerator_1
								has_technology = tech_arc_emitter_1
							}
							NOR = {
								has_technology = tech_energy_lance_2
								has_technology = tech_mass_accelerator_2
								has_technology = tech_arc_emitter_2
							}
						}
					}
					create_fleet = {
						name = "Raiders"
						settings = {
							spawn_debris = no 
							is_boss = no
						}
						effect = {
							set_owner = event_target:mem_antarans_country
							create_ship = {
								design = "Spearhead"
							}
							set_location = {
								target = PREV
								distance = 0
								angle = random 
							}
						}
					}
				}
				IF = { # raiding fleet if having researched any xl t2 weapon
					limit = {
						ROOT = {
							OR = {
								has_technology = tech_energy_lance_2
								has_technology = tech_mass_accelerator_2
								has_technology = tech_arc_emitter_2
							}
						}
					}
					create_fleet = {
						name = "Raiders"
						settings = {
							spawn_debris = no 
							is_boss = no
						}
						effect = {
							set_owner = event_target:mem_antarans_country
							create_ship = {
								design = "Spearhead"
							}
							set_location = {
								target = PREV
								distance = 0
								angle = random 
							}
						}
					}
				}
				last_created_fleet = { # fleet flag for bombarding event
					set_fleet_flag = mem_antarans_fleet
				}
				IF = { # check which attack number the empire has (1 to 5) for destruction check to know which empire will be the target of a retaliation strike
					limit = {
						ROOT = {
							has_country_flag = mem_antarans_target_1
						}
					}
					last_created_fleet = {
						set_fleet_flag = mem_antarans_fleet_1
					}
				}
				IF = { # check which attack number the empire has (1 to 5) for destruction check to know which empire will be the target of a retaliation strike
					limit = {
						ROOT = {
							has_country_flag = mem_antarans_target_2
						}
					}
					last_created_fleet = {
						set_fleet_flag = mem_antarans_fleet_2
					}
				}
				IF = { # check which attack number the empire has (1 to 5) for destruction check to know which empire will be the target of a retaliation strike
					limit = {
						ROOT = {
							has_country_flag = mem_antarans_target_3
						}
					}
					last_created_fleet = {
						set_fleet_flag = mem_antarans_fleet_3
					}
				}
				IF = { # check which attack number the empire has (1 to 5) for destruction check to know which empire will be the target of a retaliation strike
					limit = {
						ROOT = {
							has_country_flag = mem_antarans_target_4
						}
					}
					last_created_fleet = {
						set_fleet_flag = mem_antarans_fleet_4
					}
				}
				IF = { # check which attack number the empire has (1 to 5) for destruction check to know which empire will be the target of a retaliation strike
					limit = {
						ROOT = {
							has_country_flag = mem_antarans_target_5
						}
					}
					last_created_fleet = {
						set_fleet_flag = mem_antarans_fleet_5
					}
				}
			}
		}
	}
}

#Test Event to show Targets
country_event = {
	id = mem_antarans.99
	title = "Antaran Test"
	desc = "All flags have been set"
	picture = GFX_evt_mem_space_battle
	
	is_triggered_only = yes
	
	immediate = {
		random_country = {
			limit = {
				has_country_flag = mem_antarans_target_1
			}
			save_event_target_as = mem_antarans_target_1
		}		
		create_point_of_interest = {
			id = mem_antarans_target.1
			name = "mem_antarans_target_1"
			desc = "mem_antarans_target_1_desc"
			location = event_target:mem_antarans_target_1
		}
		random_country = {
			limit = {
				has_country_flag = mem_antarans_target_2
			}
			save_event_target_as = mem_antarans_target_2
		}		
		create_point_of_interest = {
			id = mem_antarans_target.2
			name = "mem_antarans_target_2"
			desc = "mem_antarans_target_2_desc"
			location = event_target:mem_antarans_target_2
		}
		random_country = {
			limit = {
				has_country_flag = mem_antarans_target_3
			}
			save_event_target_as = mem_antarans_target_3
		}		
		create_point_of_interest = {
			id = mem_antarans_target.3
			name = "mem_antarans_target_3"
			desc = "mem_antarans_target_3_desc"
			location = event_target:mem_antarans_target_3
		}
		random_country = {
			limit = {
				has_country_flag = mem_antarans_target_4
			}
			save_event_target_as = mem_antarans_target_4
		}		
		create_point_of_interest = {
			id = mem_antarans_target.4
			name = "mem_antarans_target_4"
			desc = "mem_antarans_target_4_desc"
			location = event_target:mem_antarans_target_4
		}
		random_country = {
			limit = {
				has_country_flag = mem_antarans_target_5
			}
			save_event_target_as = mem_antarans_target_5
		}		
		create_point_of_interest = {
			id = mem_antarans_target.5
			name = "mem_antarans_target_5"
			desc = "mem_antarans_target_5_desc"
			location = event_target:mem_antarans_target_5
		}
	}
	
	option = {
		name = "OK"
	}
}