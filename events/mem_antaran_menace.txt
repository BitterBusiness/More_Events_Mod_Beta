####################################
#
# Antaran Menace - Midgame Crisis
#
# Coding by Malthus
#
####################################

namespace = mem_antarans

#Setup Event at Game Start for randomly disabling the Crisis
event = {
	id = mem_antarans.1
	hide_window = yes
	
	immediate = {
		random_list = {
			3 = {
				set_global_flag = mem_antarans_disabled
			}
			1 = { }
		}
	}
}

#Empire Targeting for Raids
planet_event = {
	id = mem_antarans.2
	hide_window = yes
	
	trigger = {
		is_colony = yes
		is_capital = no
		NOR = {
			has_planet_flag = mem_antarans_raided_planet #this is a timed flag set when the planet is raided 
			has_global_flag = mem_antarans_recent_attack #this is a timed flag set at the start of a raid
			has_global_flag = mem_antarans_disabled
		}
		owner = {
			is_country_type = default
			NOR = {
				has_country_flag = mem_antarans_raided_empire #this is a timed flag set when the an empire gets attacked
				has_country_flag = mem_antarans_target_1
				has_country_flag = mem_antarans_target_2
				has_country_flag = mem_antarans_target_3
				has_country_flag = mem_antarans_target_4
				has_country_flag = mem_antarans_target_5
			}
		}
	}
	
	mean_time_to_happen = {
		months = 32
	}
	
	immediate = {
		IF = {
			limit = {
				NOT = {
					any_country = {
						has_country_flag = mem_antarans_target_1
					}
				}
			}
			owner = {
				set_country_flag = mem_antarans_target_1
			}
			ELSE = {
				IF = {
					limit = {
						NOT = {
							any_country = {
								has_country_flag = mem_antarans_target_2
							}
						}
					}
					owner = {
						set_country_flag = mem_antarans_target_2
					}
					ELSE = {
						IF = {
							limit = {
								NOT = {
									any_country = {
										has_country_flag = mem_antarans_target_3
									}
								}
							}
							owner = {
								set_country_flag = mem_antarans_target_3
							}
							ELSE = {
								IF = {
									limit = {
										NOT = {
											any_country = {
												has_country_flag = mem_antarans_target_4
											}
										}
									}
									owner = {
										set_country_flag = mem_antarans_target_4
									}
									ELSE = {
										IF = {
											limit = {
												NOT = {
													any_country = {
														has_country_flag = mem_antarans_target_5
													}
												}
											}
											owner = {
												set_country_flag = mem_antarans_target_5
											}
											#set a break between attack rounds
											set_timed_global_flag = {
												flag = mem_antarans_recent_attack
												days = 3600 # 10 years
												random = 720
											}
											#this is for testing purpose
											random_country = {
												limit = {
													is_ai = no
												}
												country_event = { id = mem_antarans.99 days = 5 }
											}
											#Following events set the Antaran Raids in motion
											random_country = {
												limit = {
													has_country_flag = mem_antarans_target_1
												}
												country_event = { id = mem_antarans.3 days = 30 random = 10 }
											}
											random_country = {
												limit = {
													has_country_flag = mem_antarans_target_2
												}
												country_event = { id = mem_antarans.3 days = 30 random = 10 }
											}
											random_country = {
												limit = {
													has_country_flag = mem_antarans_target_3
												}
												country_event = { id = mem_antarans.3 days = 30 random = 10 }
											}
											random_country = {
												limit = {
													has_country_flag = mem_antarans_target_4
												}
												country_event = { id = mem_antarans.3 days = 30 random = 10 }
											}
											random_country = {
												limit = {
													has_country_flag = mem_antarans_target_5
												}
												country_event = { id = mem_antarans.3 days = 30 random = 10 }
											}
											#Also start a notification message for all not attacked human players from here later
											every_country = {
												limit = {
													NOR = {
														has_country_flag = mem_antarans_target_1
														has_country_flag = mem_antarans_target_2
														has_country_flag = mem_antarans_target_3
														has_country_flag = mem_antarans_target_4
														has_country_flag = mem_antarans_target_5
													}
													is_ai = no
												}
												#start notification event a month later than the other events
											}
										}
									}
								}
							}
						}
					}
				}
			}
		}
	}
}

#Hidden Event to place the Ambient Object ( Dimensional Rift opening ) at the rim of a target system
country_event = {
	id = mem_antarans.3
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		IF = { # check if the empire is target of a retaliation
			limit = {
				has_country_flag = mem_antarans_retaliation
			}
			remove_country_flag = mem_antarans_retaliation
			random_owned_planet = {
				limit = {
					is_capital = yes
				}
				solar_system = {
					random_system_planet = {
						limit = {
							is_star = yes
						}
						THIS = {
							save_event_target_as = mem_antarans_target_sun
						}
					}
					create_ambient_object = { # exchange that later with a custom made one from frog
						type = "abandoned_ship_object"
					}
					random_system_ambient_object = {
						limit = { is_same_value = last_created_ambient_object }
						set_location = {
							target = event_target:mem_antarans_target_sun
							distance = 150
							angle = random
						}
						set_ambient_object_flag = mem_antarans_retaliation_rift
					}
				}
			}
			# start next event to notify the player
			country_event = { id = mem_antarans.4 days = 5 }
			ELSE = {
				IF = { # failsafe if valid raiding target has been lost in the meantime because of a war or something else - check here and use normal raiding target
					limit = {
						any_owned_planet = {
							is_colony = yes
							is_capital = no
							NOT = {
								has_country_flag = raided_planet
							}
						}
					}
					random_owned_planet = {
						limit = {
							is_colony = yes
							is_capital = no
							NOT = {
								has_planet_flag = mem_antarans_raided_planet
							}
						}
						solar_system = {
							random_system_planet = {
								limit = {
									is_star = yes
								}
								THIS = {
									save_event_target_as = mem_antarans_target_sun
								}
							}
							create_ambient_object = { # exchange that later with a custom made one from frog
								type = "abandoned_ship_object"
							}
							random_system_ambient_object = {
								limit = { is_same_value = last_created_ambient_object }
								set_location = {
									target = event_target:mem_antarans_target_sun
									distance = 150
									angle = random
								}
								set_ambient_object_flag = mem_antarans_raiding_rift
							}
						}
					}
					country_event = { id = mem_antarans.4 days = 5 }
					ELSE = { # failsafe target - if not even the capital is left there is nothing happening anyway
						random_owned_planet = {
							limit = {
								is_colony = yes
							}
							solar_system = {
								random_system_planet = {
									limit = {
										is_star = yes
									}
									THIS = {
										save_event_target_as = mem_antarans_target_sun
									}
								}
								create_ambient_object = { # exchange that later with a custom made one from frog
									type = "abandoned_ship_object"
								}
								random_system_ambient_object = {
									limit = { is_same_value = last_created_ambient_object }
									set_location = {
										target = event_target:mem_antarans_target_sun
										distance = 150
										angle = random
									}
									set_ambient_object_flag = mem_antarans_raiding_rift
								}
							}
						}
						country_event = { id = mem_antarans.4 days = 5 }
					}
				}
			}
		}
	}
}

country_event = {
	id = mem_antarans.4
	title = mem_antarans.4.name
	desc = { # for first encounter
		text = mem_antarans.4a.desc
		trigger = {
			NOT = { 
				has_country_flag = mem_antarans_retaliation 
				has_country_flag = mem_antarans_met
			}
		}
	}
	desc = { # after first encounter has happened before
		text = mem_antarans.4b.desc
		trigger = {
			NOT = { 
				has_country_flag = mem_antarans_retaliation 
			}
			has_country_flag = mem_antarans_met
		}
	}
	desc = { # for retaliation encounter
		text = mem_antarans.4c.desc
		trigger = { has_country_flag = mem_antarans_retaliation }
	}
	picture = GFX_evt_mem_space_battle # we will need custom art for a picture of one of those rifts opening
	location = event_target:mem_antarans_target_sun
	
	is_triggered_only = yes
	
	option = {
		name = "YEAHHHHHH!" # replace later
	}
}

#Test Event to show Targets
country_event = {
	id = mem_antarans.99
	title = "Antaran Test"
	desc = "All flags have been set"
	picture = GFX_evt_mem_space_battle
	
	is_triggered_only = yes
	
	immediate = {
		random_country = {
			limit = {
				has_country_flag = mem_antarans_target_1
			}
			save_event_target_as = mem_antarans_target_1
		}		
		create_point_of_interest = {
			id = mem_antarans_target.1
			name = "mem_antarans_target_1"
			desc = "mem_antarans_target_1_desc"
			location = event_target:mem_antarans_target_1
		}
		random_country = {
			limit = {
				has_country_flag = mem_antarans_target_2
			}
			save_event_target_as = mem_antarans_target_2
		}		
		create_point_of_interest = {
			id = mem_antarans_target.2
			name = "mem_antarans_target_2"
			desc = "mem_antarans_target_2_desc"
			location = event_target:mem_antarans_target_2
		}
		random_country = {
			limit = {
				has_country_flag = mem_antarans_target_3
			}
			save_event_target_as = mem_antarans_target_3
		}		
		create_point_of_interest = {
			id = mem_antarans_target.3
			name = "mem_antarans_target_3"
			desc = "mem_antarans_target_3_desc"
			location = event_target:mem_antarans_target_3
		}
		random_country = {
			limit = {
				has_country_flag = mem_antarans_target_4
			}
			save_event_target_as = mem_antarans_target_4
		}		
		create_point_of_interest = {
			id = mem_antarans_target.4
			name = "mem_antarans_target_4"
			desc = "mem_antarans_target_4_desc"
			location = event_target:mem_antarans_target_4
		}
		random_country = {
			limit = {
				has_country_flag = mem_antarans_target_5
			}
			save_event_target_as = mem_antarans_target_5
		}		
		create_point_of_interest = {
			id = mem_antarans_target.5
			name = "mem_antarans_target_5"
			desc = "mem_antarans_target_5_desc"
			location = event_target:mem_antarans_target_5
		}
	}
	
	option = {
		name = "OK"
	}
}