namespace = mem_gravekeeper

# 200 GRAVEKEEPER
# Code & idea by Frog, writing by Cc

# ENTER SYSTEM AND INITIAL PROJECT
ship_event = {
	id = mem_gravekeeper.1
	title = "mem_gravekeeper.1"
	desc = "mem_gravekeeper.1.desc"
	picture = GFX_evt_space_station
	location = FROM
	
	is_triggered_only = yes
	
	trigger = {
	    NOT = { has_global_flag = mem_grave_appeared }
		owner = {
			NOT = { has_country_flag = encountered_mem_grave }
			is_ai = no
		}
		FROM = {
			has_star_flag = mem_grave_system
			NOT = { has_star_flag = mem_grave_defeated }
		}
	}
	
	immediate = {
		FROM = { save_event_target_as = mem_gravekeeper_system }
		owner = {
			if = {
				limit = { has_event_chain = "mem_lex_grave_chain" }
				end_event_chain = "mem_lex_grave_chain"
			}
			set_country_flag = encountered_mem_grave
		}
	}		
	
	option = {
		name = "mem_gravekeeper.1.a"
		event_target:mem_gravekeeper_target = {
			enable_special_project = {
				name = "MEM_GRAVE_EXPLORE"
				location = THIS
				owner = ROOT
			}
		}
	}
}

# GRAVEKEEPER STATION SPAWN
ship_event = {
	id = mem_gravekeeper.2
	title = "mem_gravekeeper.2"
	desc = "mem_gravekeeper.2.desc"
	picture = GFX_evt_sentient_AI
	show_sound = event_activating_unknown_technology
	
	is_triggered_only = yes
	
	option = {
		name = mem_gravekeeper.2.a
		custom_tooltip = mem_gravekeeper.2.a.tooltip
		owner = { 
			add_physics_research = 1000
			add_society_research = 1000
			add_engineering_research = 1000
		}
		hidden_effect = {
			owner = { 
				country_event = { id = mem_gravekeeper.10 }
			}
			event_target:mem_gravekeeper_system = {
				random_system_ambient_object = {
					limit = { has_ambient_object_flag = mem_gravekeeper_flag }
					save_event_target_as = mem_gravekeeper_ambient
				}
			}
			create_country = {
				name = "Forlorn"
				type = mem_grave_guardian_passive
				flag = {
					icon = {
						category = "blocky"
						file = "flag_blocky_4.dds"
					}
					background= {
						category = "backgrounds"
						file = "00_solid.dds"
					}
					colors={
						"dark_grey"
						"dark_grey"
						"null"
						"null"
					}
				}
			}
			last_created_country = {
				if = {
					limit = {
						NOT = {
							has_modifier = mem_grave_power
						}
					}
					add_modifier = {
						modifier = mem_grave_power
						days = -1
					}
				}
				save_global_event_target_as = mem_grave_country
				set_country_flag = mem_grave_country
				set_graphical_culture = fallen_empire_04
				guardian_difficulty = yes
			}
			create_fleet = {
				name = "Gravekeeper"
				settings = {
					spawn_debris = no 
					is_boss = yes
				}
				effect = {
					set_owner = event_target:mem_grave_country
					create_ship = {
						name = "Murias"
						design = "Semias"
						graphical_culture = "fallen_empire_04"
						prefix = no
					}
					set_location = event_target:mem_gravekeeper_ambient
					save_global_event_target_as = mem_gravekeeper_spawn
				}
			}
			last_created_fleet = {
				create_ambient_object = {
					type = mem_effect_explosion_1_object
					location = THIS
					duration = 10
						
					use_3d_location = yes
						
					entity_offset = { min = 0 max = 0 }
					entity_offset_angle = { min = 0 max = 0 }
					entity_offset_height = { min = 0 max = 0 }
						
					entity_scale_to_size = yes
					scale = 10
				}
			}
			event_target:mem_gravekeeper_ambient = { destroy_ambient_object = this }
			set_global_flag = mem_grave_appeared
		}
	}

	option = {
		name = mem_gravekeeper.2.b
		owner = { 
			add_influence = 100
		}
	}
}

# Gravekeeper Station Activation Followups
country_event = {
	id = mem_gravekeeper.10
	title = "mem_gravekeeper.10"
	desc = "mem_gravekeeper.10.desc"
	picture = GFX_evt_sentient_AI
	location = FROM
	
	is_triggered_only = yes
	
	option = {
		name = "mem_gravekeeper.10.a"
		hidden_effect = {
			country_event = { id = mem_gravekeeper.11 days = 10 }
		}
	}
}

country_event = {
	id = mem_gravekeeper.11
	title = "mem_gravekeeper.11"
	desc = "mem_gravekeeper.11.desc"
	picture = GFX_evt_sentient_AI
	show_sound = event_red_alert
	location = FROM
	
	is_triggered_only = yes
	
	immediate = {
		every_country = {
			limit = { 
				is_country_type = mem_grave_guardian_passive
			}
			set_country_type = mem_grave_guardian
		}
	}
	
	option = {
		name = WORRYING
	}
}

# GRAVEKEEPER ASSAULT MODE (HIDDEN)
country_event = {
	id = mem_gravekeeper.20
	hide_window = yes
	
	fire_only_once = yes
	is_triggered_only = yes
	
	trigger = {
		is_country_type = mem_grave_guardian
		has_country_flag = mem_grave_country
		FROMFROM = { is_ship_size = mem_grave }
		FROM = { is_ai = no }
	}
	
	immediate = {
	    FROMFROM = {
			solar_system = { save_event_target_as = mem_grave_system }
			create_fleet = {
			name = "Awakened Gravekeeper"
			settings = {
				spawn_debris = no 
				is_boss = yes
			}
			effect = {
				set_owner = event_target:mem_grave_country
				create_ship = {
					name = "Gorias"
					design = "Esras"
					graphical_culture = "fallen_empire_04"
					prefix = no
				}
                set_location = event_target:mem_gravekeeper_spawn
				set_fleet_stance = aggressive
				set_aggro_range_measure_from = self
				set_aggro_range = 500
				
				queue_actions = {	
						repeat = {
							find_closest_planet  = {
								trigger = {
									id = mem_grave_awakened.patrol.1
									has_planet_flag = mem_graveyard_patrol_1
								}
								found_planet = {
									move_to = this
									orbit_planet = this
									wait = {
										duration = 30
									}
								}
							}
							find_closest_planet  = {
								trigger = {
									id = mem_grave_awakened.patrol.2
									has_planet_flag = mem_graveyard_patrol_2
								}
								found_planet = {
									move_to = this
									orbit_planet = this
									wait = {
										duration = 30
									}
								}
							}
							find_closest_planet  = {
								trigger = {
									id = mem_grave_awakened.patrol.3
									has_planet_flag = mem_graveyard_patrol_3
								}
								found_planet = {
									move_to = this
									orbit_planet = this
									wait = {
										duration = 30
									}
								}
							}	
							find_closest_planet  = {
								trigger = {
									id = mem_grave_awakened.patrol.6
									has_planet_flag = mem_graveyard_patrol_4
								}
								found_planet = {
									move_to = this
									orbit_planet = this
									wait = {
										duration = 30
									}
								}
							}	
						}
					}
				}
			}
			last_created_fleet = {
				create_ambient_object = {
					type = mem_effect_explosion_2_object
					location = THIS
					duration = 10
						
					use_3d_location = yes
						
					entity_offset = { min = 0 max = 0 }
					entity_offset_angle = { min = 0 max = 0 }
					entity_offset_height = { min = 0 max = 0 }
						
					entity_scale_to_size = yes
					scale = 100
				}
			}
		}
		FROM = {
			country_event = { id = mem_gravekeeper.21 }
		}
	}
}

# GRAVEKEEPER ASSAULT MODE
country_event = {
	id = mem_gravekeeper.21
	title = "mem_gravekeeper.21"
	desc = "mem_gravekeeper.21.desc"
	picture = GFX_evt_exploding_ship
	show_sound = event_red_alert
	location = event_target:mem_grave_system
	
	is_triggered_only = yes
	
	option = {
		name = "mem_gravekeeper.21.a"
	}
}

# Gravekeeper Weakness Research

country_event = {
	id = mem_gravekeeper.30
	hide_window = yes
	is_triggered_only = yes
	
	fire_only_once = yes

	trigger = {
		is_country_type = mem_grave_guardian
		any_owned_ship = {
		    OR = {
				is_ship_size = mem_grave
				is_ship_size = mem_grave_awakened
			}
			fleet = {
				exists = solar_system
				solar_system = {
				has_star_flag = mem_grave_system
				}
			}
		}
		from = {
			is_country_type = default
			is_ai = no
			any_owned_ship = {
			is_ship_class = shipclass_military 
			fleet = {
					exists = solar_system
					solar_system = {
						has_star_flag = mem_grave_system
					}
				}	
			}
			AND = {
				OR = {
					has_technology = "tech_ship_armor_5"
					has_technology = "tech_dragon_armor"
				}
				OR = {
					has_technology = "tech_shields_5"
					has_technology = "tech_enigmatic_deflector"
				}		
				OR = {
					has_technology = "tech_zero_point_power"
					has_technology = "tech_enigmatic_power_core"
				}
				OR = {
					has_technology = "tech_energy_lance_2"
					has_technology = "tech_arc_emitter_2"
					has_technology = "tech_mass_accelerator_2"
				}
			}
		}
	}

	immediate = {
		from = {
			country_event = { id = mem_gravekeeper.31 }
		}
	}
}

country_event = {
	id = mem_gravekeeper.31
	title = "mem_gravekeeper.31"
	desc = "mem_gravekeeper.31.desc"
	picture = GFX_evt_exploding_ship
	is_triggered_only = yes
	
	fire_only_once = yes

	trigger = {
		from = { is_country_type = mem_grave_guardian }
		is_country_type = default
		is_ai = no
		NOT = { has_country_flag = mem_grave_weakness_researched }
	}

	option = {
		name = mem_gravekeeper.31.a
		allow = {
			hidden_trigger = {
				NOT = { has_modifier = mem_grave_weakness }
			}
		}
		capital_scope = { save_event_target_as = mem_pc_home }
		hidden_effect = { set_country_flag = mem_grave_weakness_researched }
		enable_special_project = {
			name = "MEM_GRAVE_WEAKNESS_PROJECT"
			location = event_target:mem_pc_home
			owner = ROOT
		}
	}
	option = {
		name = mem_gravekeeper.31.b
		add_influence = 100
	}
}

country_event = {
	id = mem_gravekeeper.32
	title = "mem_gravekeeper.32"
	desc = "mem_gravekeeper.32.desc"
	picture = GFX_evt_physics_research
	is_triggered_only = yes
	
	option = {
		name = mem_gravekeeper.32.a

		add_modifier = {
			modifier = mem_grave_weakness
			days = 36000
		}
	}
}

# GRAVEKEEPER DISABLED (HIDDEN)
country_event = {
	id = mem_gravekeeper.40
	hide_window = yes
	
	fire_only_once = yes
	is_triggered_only = yes
	
	trigger = {
		is_country_type = mem_grave_guardian
		has_country_flag = mem_grave_country
		FROMFROM = { is_ship_size = mem_grave_awakened }
		FROM = { is_ai = no }
	}
	
	immediate = {
	    FROMFROM  = {
			solar_system = { save_event_target_as = mem_grave_system }
			create_ambient_object = {
						type = mem_effect_explosion_5_object
						location = THIS
						duration = 10
						
						use_3d_location = yes
						
						entity_offset = { min = 0 max = 0 }
						entity_offset_angle = { min = 0 max = 0 }
						entity_offset_height = { min = 0 max = 0 }
						
						entity_scale_to_size = yes
						scale = 100
			}
			create_ambient_object = {
			type = "mem_gravekeeper_pc_object"
			location = THIS
			}
			last_created_ambient_object = { save_global_event_target_as = mem_disabled_gravekeeper_object }
			create_ambient_object = {
				type = "large_debris_object"
				location = THIS
			}
			last_created_ambient_object = { set_ambient_object_flag = mem_gravekeeper_debris }
		}
		FROM = {
			country_event = { id = mem_gravekeeper.41 }
			set_country_flag = mem_grave_slayer
			save_event_target_as = mem_grave_slayer
		}
		every_country = {
			limit = { 
				is_country_type = default
				has_modifier = mem_grave_weakness
			}
			remove_modifier = "mem_grave_weakness"
		}
		every_country = {
			limit = {
				is_ai = no
				is_country_type = default
				has_special_project = MEM_GRAVE_WEAKNESS_PROJECT
			}
			abort_special_project = {
				type = "MEM_GRAVE_WEAKNESS_PROJECT"
				location = capital_scope
			}
		}
		every_country = {
			country_event = { id = crisis.10 days = 18000 random = 500 }
		}
		add_threat = {
			who = FROM
			amount = 100
		}
		destroy_country = yes
	}
}

# GRAVEKEEPER DISABLED
country_event = {
	id = mem_gravekeeper.41
	title = "mem_gravekeeper.41"
	desc = "mem_gravekeeper.41.desc"
	picture = GFX_evt_small_space_battle
	location = event_target:mem_grave_system
	
	is_triggered_only = yes
	
	option = {
		name = "mem_gravekeeper.41.a"
		event_target:mem_disabled_gravekeeper_object = {
			enable_special_project = {
				name = "MEM_GRAVE_PC_PROJECT"
				location = THIS
				owner = ROOT
			}
		}
	}
	option = {
		name = "mem_gravekeeper.41.b"
		add_minerals = 10000
		add_energy = 10000
		hidden_effect = {
			event_target:mem_disabled_gravekeeper_object = { destroy_ambient_object = this }
			solar_system = {
				random_system_ambient_object = {
					limit = { has_ambient_object_flag = mem_gravekeeper_debris }
					destroy_ambient_object = this
				}
				save_event_target_as = mem_grave_system
			}
		}
	}
}

# GRAVEKEEPER RESTORED
ship_event = {
	id = mem_gravekeeper.50
	title = "mem_gravekeeper.50"
	desc = "mem_gravekeeper.50.desc"
	picture = GFX_evt_ship_in_orbit
	show_sound = event_mystic_reveal
	location = event_target:mem_grave_system
	
	is_triggered_only = yes
	
	immediate = {
		owner = {
			save_event_target_as = mem_grave_project_owner 
			add_threat = {
			who = owner 
			amount = 10
			}
		}
	}
	
	option = {
		name = "mem_gravekeeper.50.a"
		create_fleet = {
			name = "Gravekeeper"
			settings = {
				spawn_debris = no 
				is_boss = yes
			}
			effect = {
				set_owner = event_target:mem_grave_project_owner
				create_ship = {
					name = "Finias"
					design = "Fessus"
					graphical_culture = "fallen_empire_04"
					prefix = no
				}
				set_location = {
					target = event_target:mem_disabled_gravekeeper_object
					distance = 0
					angle = random
				}
			}
		}
		hidden_effect = {
			event_target:mem_disabled_gravekeeper_object = { destroy_ambient_object = this }
			solar_system = {
				random_system_ambient_object = {
					limit = { has_ambient_object_flag = mem_gravekeeper_debris }
					destroy_ambient_object = this
				}
			}
		}
	}
}

# Gravekeeper Enhancement Research
country_event = {
	id = mem_gravekeeper.60
	title = "mem_gravekeeper.60"
	desc = "mem_gravekeeper.60.desc"
	picture = GFX_evt_unspeakable_horror
	
	fire_only_once = yes
	
	trigger = {
		is_ai = no
		is_country_type = default
		has_country_flag = mem_grave_slayer
		any_owned_ship = {
			is_ship_size = mem_grave_awakened_pc_bound
		}
	}
	
	mean_time_to_happen = {
		years = 50

		modifier = {
			factor = 0.5
			has_country_flag = mem_titan_slayer
		}
		
		modifier = {
			factor = 0.5
			has_country_flag = mem_conduit_slayer
		}
		
		modifier = {
			factor = 0.1
			AND = {
				has_country_flag = mem_titan_slayer
				has_country_flag = mem_conduit_slayer
			}
		}
	}
	
	immediate = {
		capital_scope = { save_event_target_as = mem_pc_home }
	}
	
	option = {
		name = "mem_gravekeeper.60.a"
		event_target:mem_pc_home = {
			enable_special_project = {
				name = "MEM_GRAVE_AWAKENING"
				location = THIS
				owner = ROOT
			}
		}
	}
	option = {
		name = "mem_gravekeeper.60.b"
		add_influence = 100
	}
}

country_event = {
	id = mem_gravekeeper.61
	title = "mem_gravekeeper.61"
	desc = "mem_gravekeeper.61.desc"
	picture = GFX_evt_ship_in_orbit
	
	is_triggered_only = yes
	
	trigger = {
			is_ai = no
			is_country_type = default
			has_country_flag = mem_grave_slayer
			NOT = { has_country_flag = mem_grave_awakening }
			any_owned_ship = {
			is_ship_size = mem_grave_awakened_pc_bound
			}
		}

	option = {
		name = "mem_gravekeeper.322.a"
		hidden_effect = { set_country_flag = mem_grave_awakening }
	}	
}

country_event = {
	id = mem_gravekeeper.70
	title = "mem_gravekeeper.70"
	desc = "mem_gravekeeper.70.desc"
	picture = GFX_evt_small_space_battle
	show_sound = event_mystic_reveal

	fire_only_once = yes
	is_triggered_only = yes
	
	trigger = {
		is_ai = no
		is_country_type = default
		has_country_flag = mem_grave_slayer
		has_country_flag = mem_grave_awakening
		FROMFROM = { is_ship_size = mem_grave_awakened_pc_bound }
	}
	
	immediate = {
		add_threat = {
			who = ROOT
			amount = 10
		}
		FROMFROM = {
			save_event_target_as = mem_grave_pc_spawn
		}
		create_fleet = {
			name = "Awakened Gravekeeper"
			settings = {
				spawn_debris = no 
				is_boss = yes
			}
			effect = {
				set_owner = PREV
				while = {
					count = 1
					create_ship = {
						name = "Finias"
						design = "Uscias"
						graphical_culture = "fallen_empire_03"
						prefix = no
					}
				}
                set_location = {
					target = event_target:mem_grave_pc_spawn
					distance = 0
					angle = random
					}	
				}
			}
			last_created_fleet = {
				create_ambient_object = {
					type = mem_effect_explosion_5_object
					location = THIS
					duration = 10
						
					use_3d_location = yes
						
					entity_offset = { min = 0 max = 0 }
					entity_offset_angle = { min = 0 max = 0 }
					entity_offset_height = { min = 0 max = 0 }
						
					entity_scale_to_size = yes
					scale = 100
				}
			}	
	}
	option = {
		name = "mem_gravekeeper.70.a"
	}
}
